<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Jigsaw Puzzle Solver</title>
    <!-- Use local opencv if available, or fall back to CDN -->
    <script async src="js/lib/opencv.js" onload="onOpenCvReady();" onerror="this.onerror=null;this.src='https://docs.opencv.org/4.8.0/opencv.js';" type="text/javascript"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <h1>üß© AI Jigsaw Puzzle Solver</h1>

        <div class="card">
            <div class="instructions">
                <h3>üì∏ How to use:</h3>
                <ul>
                    <li>Upload a reference image (completed puzzle)</li>
                    <li>Take a photo of your puzzle pieces</li>
                    <li>AI uses OpenCV contour detection for piece identification</li>
                    <li>ORB feature matching finds piece positions</li>
                    <li>Get smart suggestions for assembly</li>
                </ul>
                <div id="cvStatus" style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 5px; font-size: 12px; display: none;">
                    ‚è≥ Loading OpenCV.js for advanced detection...
                </div>
            </div>

            <div class="reference-section">
                <h3 style="font-size: 14px; margin-bottom: 10px; color: #667eea;">Step 1: Upload Reference Image (Optional)</h3>
                <button class="btn btn-success" id="uploadReferenceBtn">
                    <span>üñºÔ∏è</span>
                    Upload Completed Puzzle Image
                </button>
                <input type="file" id="referenceInput" accept="image/*">
                <img id="referencePreview" alt="Reference preview">
            </div>

            <div style="margin-top: 20px;">
                <h3 style="font-size: 14px; margin-bottom: 10px; color: #667eea;">Step 2: Choose Mode</h3>
                <button class="btn live-mode-btn" id="liveSolveBtn" disabled>
                    <span>üé•</span>
                    Live Solve Mode (Upload Reference First)
                </button>
                <button class="btn btn-primary" id="cameraBtn">
                    <span>üì∑</span>
                    Take Photo of Pieces
                </button>
                <button class="btn btn-secondary" id="uploadBtn">
                    <span>üìÅ</span>
                    Upload Image
                </button>
                <input type="file" id="fileInput" accept="image/*">
            </div>
        </div>

        <div class="live-solve-container" id="liveSolveContainer">
            <div class="card">
                <h2 style="color: #667eea;">üé• Live Solve Mode</h2>
                <div style="position: relative;">
                    <video id="liveVideo" autoplay playsinline></video>
                    <canvas id="overlayCanvas" class="live-overlay"></canvas>
                    <div class="live-controls">
                        <label>Reference Overlay Opacity</label>
                        <div class="slider-container">
                            <input type="range" id="opacitySlider" min="0" max="100" value="50">
                            <span class="slider-value" id="opacityValue">50%</span>
                        </div>
                        <label>Grid Lines</label>
                        <div class="slider-container">
                            <input type="checkbox" id="gridToggle" checked>
                            <span style="color: white; font-size: 12px;">Show Grid</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary" id="exitLiveBtn" style="margin-top: 15px;">
                    <span>‚úñÔ∏è</span>
                    Exit Live Mode
                </button>
            </div>
        </div>

        <div class="camera-container" id="cameraContainer">
            <div class="card">
                <video id="video" autoplay playsinline></video>
                <div class="camera-overlay"></div>
                <div class="camera-hint">Position puzzle pieces within the frame</div>
                <button class="btn btn-primary" id="captureBtn" style="margin-top: 15px;">
                    <span>üì∏</span>
                    Capture Photo
                </button>
                <button class="btn btn-secondary" id="cancelBtn">
                    <span>‚úñÔ∏è</span>
                    Cancel
                </button>
            </div>
        </div>

        <canvas id="canvas"></canvas>
        <canvas id="processCanvas"></canvas>
        <canvas id="referenceCanvas"></canvas>

        <div class="card" id="previewCard" style="display: none;">
            <img id="imagePreview" alt="Puzzle preview">
            <div class="status" id="statusMessage"></div>
            <button class="btn btn-primary" id="analyzeBtn">
                <span>üîç</span>
                Analyze Puzzle
            </button>
            <button class="btn btn-secondary" id="retakeBtn">
                <span>üîÑ</span>
                Take Another Photo
            </button>
        </div>

        <div class="card" id="resultsCard" style="display: none;">
            <h2>AI Analysis Results</h2>

            <div class="ai-suggestion" id="aiSuggestion" style="display: none;">
                <h4>ü§ñ AI Solving Strategy:</h4>
                <ul id="suggestionsList"></ul>
            </div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="piecesCount">0</div>
                    <div class="stat-label">Pieces Detected</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="edgePieces">0</div>
                    <div class="stat-label">Edge Pieces</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="colorGroups">0</div>
                    <div class="stat-label">Color Groups</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="matchConfidence">0%</div>
                    <div class="stat-label">Match Confidence</div>
                </div>
            </div>

            <div class="solver-controls">
                <h3 style="font-size: 14px; margin-bottom: 10px;">Filter by Color:</h3>
                <div class="color-groups" id="colorGroupsContainer"></div>
            </div>

            <div id="piecesContainer"></div>
        </div>
    </div>

    <script src="js/script.js"></script>
</body>
</html>
